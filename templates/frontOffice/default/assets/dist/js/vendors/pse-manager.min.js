!function(a){"use strict";function b(b){return b instanceof jQuery?b:"string"==typeof b?a(b):null}function c(b){return this.each(function(){var c=a(this),e=c.data("bs.psemanager"),f=a.extend({},d.DEFAULTS,c.data(),"object"==typeof b&&b);e||c.data("bs.psemanager",e=new d(this,f)),"string"==typeof b&&e[b]()})}var d=function(b,c){this.$element=a(b),this.init(c),this.buildForm(),this.updateProductForm()};d.DEFAULTS={id:a("#pse-id"),product:a("#product"),name:a("#pse-name"),ref:a("#pse-ref"),ean:a("#pse-ean"),availability:a("#pse-availability"),validity:a("#pse-validity"),quantity:a("#quantity"),promo:a("#pse-promo"),"new":a("#pse-new"),weight:a("#pse-weight"),price:a("#pse-price"),priceOld:a("#pse-price-old"),submit:a("#pse-submit"),optionselector:"#pse-options",selectOpt:{},pseId:null,usefallback:!1,fallback:a("#pse-options .pse-fallback"),data:null,combination:null,combinationval:null,checkavailability:!0,defaultstock:100},d.prototype.init=function(a){this.id=b(a.id),this.product=b(a.product),this.name=b(a.name),this.ref=b(a.ref),this.ean=b(a.ean),this.availability=b(a.availability),this.validity=b(a.validity),this.quantity=b(a.quantity),this.promo=b(a.promo),this["new"]=b(a["new"]),this.weight=b(a.weight),this.price=b(a.price),this.priceOld=b(a.priceOld),this.submit=b(a.submit),this.optionselector=a.optionselector,this.selectOpt=a.selectOpt,this.pseId=a.pseId,this.usefallback=a.usefallback,this.fallback=b(a.fallback),this.data=a.data,this.combination=a.combination,this.combinationval=a.combinationval,this.checkavailability=a.checkavailability,this.defaultstock=a.defaultstock},d.prototype.buildForm=function(){var b,c=null,d=null,e=null,f=null,g=[],h=this.$element;if(this.pseId=this.getDefaultPSE(),Object.keys(this.data).length>1)if(this.usefallback=this.useFallback(),this.usefallback){a(this.optionselector+" .option-option").remove();for(c in this.data){if(f=this.data[c].combinations,g=[],void 0!==f)for(b=0;b<f.length;b++)g.push(this.combinationval[f[b]][0]);this.fallback.append("<option value='"+c+"'>"+g.join(", ")+"</option>")}a(this.optionselector+" .pse-fallback").on("change",function(){h.psemanager("updateProductForm")})}else{a(this.optionselector+" .option-fallback").remove(),a(this.optionselector+" .pse-option").each(function(){var b=a(this);b.data("attribute")in this.combination?(h.selectOpt[b.data("attribute")]=b,b.on("change",function(){h.psemanager("updateProductForm")})):b.closest(".option").remove()});for(e in this.combinationval)d=this.combinationval[e],this.selectOpt[d[1]].append("<option value='"+e+"'>"+d[0]+"</option>");this.setPseForm()}},d.prototype.useFallback=function(){var a,b,c=null,d=-1,e=0;for(c in this.data)if(a=this.data[c].combinations,void 0!==a){for(e=0,b=0;b<a.length;b++)e+=this.combinationval[a[b]][1];if(-1==d)d=e;else if(d!=e)return!0}return 0>=d},d.prototype.setPseForm=function(a){var b,c=null;if(c=this.data[a||this.pseId||this.getDefaultPSE()],void 0!==c)if(this.usefallback)this.fallback.val(c.id);else if(void 0!==c)for(var d=0;d<c.combinations.length;d++)b=c.combinations[d],this.selectOpt[this.combinationval[b][1]].val(c.combinations[d])},d.prototype.updateProductForm=function(){var a,b=null;Object.keys(this.data).length>1&&(this.usefallback?b=this.fallback.val():(a=this.getFormSelection(),b=this.pseExist(a),b?this.validity.hide():(this.displayNotice(),this.setPseForm())),this.id.val(b),this.pseId=b),this.updateProductUI()},d.prototype.getFormSelection=function(){var a,b=[];for(a in this.selectOpt)b.push(this.selectOpt[a].val());return b},d.prototype.pseExist=function(a){var b,c,d,e,f,g=null;for(g in this.data)if(b=g,c=this.data[g].combinations,void 0!==c){for(d=0;d<a.length;d++){for(f=!1,e=0;e<c.length;e++)if(a[d]==c[e]){f=!0;break}if(f===!1)break}if(f)return b}return!1},d.prototype.displayNotice=function(){var a=this.validity;a.stop().show("fast",function(){setTimeout(function(){a.stop().hide("fast")},3e3)})},d.prototype.updateProductUI=function(){var a,b,c=this.data[this.pseId],d=[];if(void 0!==c){if(this.ref.html(c.ref),Object.keys(this.data).length>1){for(b=0;b<c.combinations.length;b++)a=c.combinations[b],d.push(this.combinationval[a][0]);this.name.html(" - "+d.join(", "))}c.isPromo?this.product.addClass("product--is-promo"):this.product.removeClass("product--is-promo"),c.isNew?this.product.addClass("product--is-new"):this.product.removeClass("product--is-new"),c.quantity>0||!this.checkavailability?(this.setProductAvailable(!0),parseInt(this.quantity.val())>c.quantity&&this.quantity.val(c.quantity),this.checkavailability?this.quantity.attr("max",c.quantity):(this.quantity.attr("max",this.defaultstock),this.quantity.val("1"))):this.setProductAvailable(!1),c.isPromo?(this.priceOld.html(c.price),this.price.html(c.promo)):(this.priceOld.html(""),this.price.html(c.price))}else this.setProductAvailable(!1)},d.prototype.setProductAvailable=function(a){a?(this.availability.removeClass("out-of-stock").addClass("in-stock").attr("href","http://schema.org/InStock"),this.submit.prop("disabled",!1)):(this.availability.removeClass("in-stock").addClass("out-of-stock").attr("href","http://schema.org/OutOfStock"),this.submit.prop("disabled",!0))},d.prototype.getDefaultPSE=function(){for(var a in this.data){var b=this.data[a];if(b.isDefault)return b.id}return this.data[a]};var e=a.fn.collapse;a.fn.psemanager=c,a.fn.psemanager.Constructor=d,a.fn.psemanager.noConflict=function(){return a.fn.psemanager=e,this}}(jQuery);